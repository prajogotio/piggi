<html>
<head>
	<script src="Vec2.js"></script>
	<script src="ds.js"></script>
	<script src="qpath.js"></script>
	<script src="Sprite.js"></script>
	<script src="flocking.js"></script>
</head>
<body>
	<canvas id="canvas" width="1024" height="640"></canvas>

	<script>
	var canvas = document.getElementById("canvas");
	var g = canvas.getContext("2d");
	var center = new Vec2(canvas.width/2, canvas.height/2);
	
	var asset = ["asset/pig_running.png", "asset/pig_standby.png"];
	var images = {};
	var loadedAssetCount = 0;

	function loadAsset(url) {
		var img = new Image();
		img.onload = function() {
			images[url] = img;
			loadedAssetCount++;
			if (loadedAssetCount == asset.length) {
				startTest();
			}
		}
		img.src = url;
	}

	for (var i = 0; i < asset.length; ++i) {
		loadAsset(asset[i]);
	}


	function generatePig(pos) {
		var f = new FlockPrite(100, pos);
		f.setSprite(f.STANDBY, new Sprite(images["asset/pig_standby.png"], 0, 0, 128, 128, 4, 20));
		f.setSprite(f.MOVING, new Sprite(images["asset/pig_running.png"], 0, 0, 128, 128, 6, 12));
		return f;
	}

	var map = {
		width : 22, 
		height : 22,
		size : 128,
	}
	map.data = new Int32Array(map.width*map.height).fill(1);
	var path = [];
	var size = map.size;
	var start = [0,0];
	var end = [0,0];
	var state = 'BLOCK';
	var isdown = false;

	var f = [];
	function startTest() {
		f = [
			generatePig(center),
			generatePig(center),
			generatePig(center),
			generatePig(center),
			generatePig(center),
			generatePig(center),
			generatePig(center),
			];
		
		setInterval(function(){
			g.clearRect(0, 0, canvas.width, canvas.height);

			g.fillStyle="rgb(100,100,100)";
			for(var i = 0; i < map.height; ++i){
				for(var j = 0; j < map.width; ++j){
					if (map[i*map.width+j]==0) {
						g.fillRect(j*size,i*size,size,size);
					}
				}
			}

			

			updateFlocking(f, map);
			
			g.fillStyle="rgb(200,255,200)";
			if (path.length > 0) {
				for (var i = 0; i < path.length;++i){
					g.fillRect(path[i][1]*size,path[i][0]*size,size,size);
				}
			}

			g.fillStyle="red";
			g.fillRect(start[1]*size,start[0]*size,size,size);
			g.fillStyle="orange";
			g.fillRect(end[1]*size,end[0]*size,size,size);


			for(var i=0;i<f.length;++i){
				f[i].render(g);
				if (f[i].target) {
					g.fillStyle="blue";
					g.fillRect(f[i].target.x, f[i].target.y, 10, 10);
				}
			}


			
			for(var i = 0; i < map.height; ++i){
				for(var j = 0; j < map.width; ++j){
					g.strokeRect(j*size,i*size,size,size);
				}
			}

		}, 1000/60);
	}

	canvas.addEventListener("mousedown", function(e) {
		var x = e.offsetX;
		var y = e.offsetY;
		var i = Math.floor(y/size);
		var j = Math.floor(x/size);
		isdown = true;
		if (state == 'START') {
			start = [i, j];
		} else if (state == 'END') {
			end = [i, j];
		} else if (state == 'BLOCK'){
			map[i*map.width+j] = 0;
		}
		path = findPath(start, end, map);
	});
	canvas.addEventListener("mouseup",function(e) {
		isdown = false;
	})
	canvas.addEventListener("mousemove", function(e) {
		if(!isdown) return;
		var x = e.offsetX;
		var y = e.offsetY;
		var i = Math.floor(y/size);
		var j = Math.floor(x/size);
		if (state == 'START') {
			start = [i, j];
		} else if (state == 'END') {
			end = [i, j];
		} else if (state == 'BLOCK'){
			map[i*map.width+j] = 0;
		}
		path = findPath(start, end, map);
	});
	document.addEventListener('keydown', function(e) {
		if (e.which == 65) {
			state = 'START';
		} else if (e.which == 66) {
			state = 'END';
		} else if (e.which == 67) {
			state = 'BLOCK';
		} else if (e.which == 13) {
			var cppath = [];
			for (var i = 0; i < path.length; ++i) {
				cppath.push(new Vec2((path[i][1]+0.5)*size,(path[i][0]+0.5)*size));
			}
			for(var i = 0; i < f.length; ++i) {
				f[i].pos = new Vec2(start[1]*size+size/2, start[0]*size+size/2);
				f[i].velocity.x = f[i].velocity.y = f[i].force.x = f[i].force.y = 0;
				f[i].setPath(cppath.slice());
			}
		}
	})
	</script>
</body>
</html>